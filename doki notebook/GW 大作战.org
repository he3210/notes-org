#+TITLE: GW 大作战

** 注意事项
- 协同时间段内，直播间有个协同结束倒计时，且每隔 3s 和服务端同步一次
- 活动期间主播开播后每隔 10min 会出现协同时间，协同时间 20s，每次送礼协同时间增加 7s
- 活动最后一天的截止时间之后，不再进行积分计算，也就是不再计入榜单之内
- 一次协同时间段内，每个用户的五月病礼物只能一个礼物有加成，其它五月病礼物没有加成
- 本次直播送五月病礼物历史
  1. 按送礼时间进行排序
  2. 下发所有送五月病礼物的历史
  3. 一个用户多次送五月病礼物，算一个历史
- 当天最长的一次直播不满 30min，明天连续开播天数清零
- base_score = 五月病礼物总 gold
- reward_score = 五月病礼物总 gold * (连续开播奖励系数-1)
- 开播不足 30min 时，下发的基础分数和奖励分数是否算上加成系数
- 活动总榜 score = 总五月病礼物 gold * 连续开播系数。满 30min 算系数，不满不算
- 协力榜单 score = 协同时间段内送礼人数 * 礼物单价 * 协同系数 1.4
- 正常时间和协同时间交替出现，而不是协同时间包含在正常时间之内
- 协同结束后，会发送：xxx为主播点亮烽火台，增加 xx 分，这个分是协同分（协同分 = 协同时间段送五月病礼物人数 * 礼物单价 * 协同系数 1.4）？
- 发红包 20% 的人获得 gold，gold 总额为本次协同的10%。本次协同时间段内收礼总 gold 的 10%

** api
*** 直播间浮动 icon2
现有接口：api.events_v2.floating_icon，新增下发字段：
- 连续开播天数
- 加倍奖励

*** 合力协作。耗时严重，函数返回值加 lru 缓存
点击浮动 icon 弹窗时调用该接口
1. 连续开播天数
2. 基础分数 = 正常时间段内主播收礼数量 + 协同时间内送礼人数 * 加成倍数 
3. 奖励分数 = 收礼 gold * 连续开播加成系数
4. 10min 倒计时
5. 本次直播连击历史
6. 本次开播持续时长  :: 开播 30min 后，奖励分数变绿色；开播不满 30min，奖励分数为红色

*** 排行榜
点击浮动 icon 弹窗时调用该接口
1. 合力排行榜
2. 活动总榜

*** 协同时间段内同步
下发内容：
1. 是否处于协同时间段
2. 当前协同总时间
3. 当前剩余时间
4. 当前参与的协同人数
5. 在活动期间，在协同时间段内该用户是否送过五月病礼物
6. 下发五月病礼物相关信息

** websocket 消息

*** 协同时间开始前 10s 发送系统消息
 - 文案："系统通知：10s后协同时间即将开始"
 - MSG MSG fanout msg_type = "system" comment_type = "system"
*** 协同时间开始向直播间聊天区发送消息
 - 文案 :: 待定
*** 协同时间开始，向直播间非主播用户群发按钮消息，通知客户端展示送礼按钮
 - 文案 :: 是否有文案
 - 是否处于协同时间段
 - 协同总时间
 - 当前剩余协同时间
 - 五月病礼物相关信息（gift_id，icon 等）是否由服务端下发
 - 定义新的 COMMAND PARAM，fanout
 - 待定 :: 在协同时间段内进入直播间也能看到按钮
*** 协同结束，推送消息关闭送礼按钮
*** 协同结束，发送红包
 - 文案 :: 是否带有文案
 - 红包数额 :: 红包是直接发 gold 吗
 - 红包已经有了。需要确定是哪个 COMMAND PARAM。single
*** 协同结束，群发弹幕
 - 文案 :: xx为主播点亮烽火台，增加xx分
 - MNY MSG fanout，弹幕类型 mny_msg_type 应该是 0，也就是普通弹幕
*** 协同结束，发送背包礼物
 - 文案 :: xx用户带队帮助主播点燃了烽火台，获得了小礼物奖励
 - 背包礼物详情、礼物数量
 - fanout
*** 气泡

** TODO
1. 通知--push 测试
2. 实时计算协力榜
3. 官方直播间不再发 websocket 协同时间前 10s、协同时间开始消息
   - 测试官方 uid: u7818641549880507120001227
   - 生产环境 uid: u3772271542676819130001272 u6352461527058832110001318 u9317851526900454100001279
4. 活动时间可配置、礼物可配置
   - 活动开始时间
   - 活动结束时间
   - 活动礼物信息
5. 2 人以上协同没有下发红包
6. 10:30min push 消息

** 线上问题

